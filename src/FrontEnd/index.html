<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictionary</title>
    <style>
        .row {
            padding: 2px;
        }

        .row:after {
            content: "";
            display: table;
            clear: both;
        }

        .chosen {
            background-color: lightgreen;
        }

        button {
            min-width: 80px;

        }

        textarea {
            width: 400px;
        }
    </style>
    <script type="importmap">
        {
          "imports": {
            "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
          }
        }
      </script>
</head>

<body>

    <div id="app">
        <div>
            <p>Type in the textfield, use arrow keys [Up], [Down] and [Enter] in order to choose suggestions:</p>
            <textarea id="textarea" cols="2" rows="5" v-model="input" @input="updateText" @keyup.enter="choose"
                @keyup.up="choosePrev" @keyup.down="chooseNext" ref="text"></textarea>
        </div>

        <div>
            <span>Suggestions: </span>
            <div class="row" v-for="(suggestion, index) in suggestions">
                <button v-if="index === predictionIndex" @click="add(suggestion)" class="chosen">
                    {{suggestion}}
                </button>
                <button v-if="index !== predictionIndex" @click="add(suggestion)">{{suggestion}}
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp } from 'vue'

        createApp({
            data() {
                return {
                    input: 'cat',
                    suggestions: [],
                    timeoutHandler: null,
                    predictionIndex: null,
                    lastWord: '',
                    process: false
                }
            },
            methods: {
                updateText() {
                    let self = this;
                    clearTimeout(self.timeoutHandler);
                    self.timeoutHandler = setTimeout(() => {
                        self.findSuggestions();
                    }, 300);

                },
                add(suggestion) {
                    let self = this;
                    let cursor = getCursorPosition(),
                        val = self.input,
                        strLeft = val.substring(0, cursor.start),
                        strRight = val.substring(cursor.start),
                        lastIndex = val.lastIndexOf(" ");

                    strLeft = val.substring(0, lastIndex) + " ";
                    self.input = strLeft + suggestion + strRight;
                    setCursorPosition(strLeft.length + suggestion.length);
                    self.predictionIndex = null;
                    self.$refs.text.focus();
                },
                choose: function () {
                    if (this.predictionIndex === null) {
                        return;
                    }
                    if (this.input[this.input.length - 1] === '\n') this.input = this.input.slice(0, -1);
                    this.add(this.suggestions[this.predictionIndex]);
                },
                chooseNext: function (event) {
                    if (this.predictionIndex === null) {
                        this.predictionIndex = 0;
                    } else {
                        this.predictionIndex = (this.predictionIndex < this.suggestions.length - 1) ? this.predictionIndex + 1 : null;
                    }
                    this.$refs.text.focus();
                },
                choosePrev: function (event) {
                    if (this.predictionIndex === null) {
                        this.predictionIndex = this.suggestions.length - 1;
                    } else {
                        this.predictionIndex = this.predictionIndex > 0 ? this.predictionIndex - 1 : null;
                    }
                    this.$refs.text.focus();
                },
                findSuggestions() {
                    let self = this;
                    let words = self.input.split(" ");
                    self.lastWord = words[words.length - 1]
                    if (self.lastWord.length <= 2) retuen;
                    if (self.process) retuen;
                    self.process = true;
                    fetch(`https://localhost:7189/api/WordPredicts?text=${self.lastWord}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Basic YWRtOjIwNDA=',
                            'Accept': 'application/json',
                            'Content-Type': 'application/json;charset=utf-8'
                        }
                    })
                        .then((response => {
                            if (response.ok) {
                                return response.json();
                            } else {
                                alert("Server returned " + response.status + " : " + response.statusText);
                            }
                        })).then(response => {
                            self.suggestions = response.map(e => e.value);
                            this.process = false;
                        })
                        .catch(err => {
                            console.log(err);
                        });
                }
            }

        }).mount('#app')


        function getCursorPosition() {
            let el = document.getElementById("textarea");
            let start = 0, end = 0, normalizedValue, range, textInputRange, len, endRange;
            if (typeof el.selectionStart == "number" && typeof el.selectionEnd == "number") {
                start = el.selectionStart;
                end = el.selectionEnd;
            } else {
                range = document.selection.createRange();

                if (range && range.parentElement() == el) {
                    len = el.value.length;
                    normalizedValue = el.value.replace(/\r\n/g, "\n");

                    // Create a working TextRange that lives only in the input
                    textInputRange = el.createTextRange();
                    textInputRange.moveToBookmark(range.getBookmark());

                    // Check if the start and end of the selection are at the very end
                    // of the input, since moveStart/moveEnd doesn't return what we want
                    // in those cases
                    endRange = el.createTextRange();
                    endRange.collapse(false);

                    if (textInputRange.compareEndPoints("StartToEnd", endRange) > -1) {
                        start = end = len;
                    } else {
                        start = -textInputRange.moveStart("character", -len);
                        start += normalizedValue.slice(0, start).split("\n").length - 1;

                        if (textInputRange.compareEndPoints("EndToEnd", endRange) > -1) {
                            end = len;
                        } else {
                            end = -textInputRange.moveEnd("character", -len);
                            end += normalizedValue.slice(0, end).split("\n").length - 1;
                        }
                    }
                }
            }
            return {
                start: start,
                end: end
            };
        }

        function setCursorPosition(start, end) {
            let input = document.getElementById("textarea");
            if (arguments.length < 3) end = start;
            if ("selectionStart" in input) {
                setTimeout(function () {
                    input.selectionStart = start;
                    input.selectionEnd = end;
                }, 1);
            }
            else if (input.createTextRange) {
                let rng = input.createTextRange();
                rng.moveStart("character", start);
                rng.collapse();
                rng.moveEnd("character", end - start);
                rng.select();
            }
        }

    </script>
</body>

</html>